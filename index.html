<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2c3e50" />
  <meta name="description" content="Calculadora interna para asesores financieros" />
  <title>Calculadora principal</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192'/><text x='50%' y='50%' font-size='100' fill='white' text-anchor='middle' dominant-baseline='middle'>$</text></svg>">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 520px;
      width: 100%;
      padding: 30px;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 15px;
    }

    h1 { color: #2c3e50; font-size: 28px; margin-bottom: 5px; }

    .subtitle { color: #7f8c8d; font-size: 14px; }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      color: #2c3e50;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ecf0f1;
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus { outline: none; border-color: #667eea; }

    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }

    button:active { transform: scale(0.98); }

    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none;
    }

    .results.show { display: block; }

    .result-item {
      display: flex;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #ecf0f1;
      align-items: center;
    }

    .result-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

    .result-label { color: #7f8c8d; font-weight: 600; }

    .result-value { color: #2c3e50; font-weight: 700; font-size: 16px; text-align: right; }

    .install-btn {
      background: #27ae60;
      margin-top: 20px;
      display: none;
    }

    .install-btn.show { display: block; }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #7f8c8d;
      line-height: 1.4;
    }

    .max-loan {
      font-size: 22px;
      font-weight: 800;
      text-decoration: underline;
      line-height: 1.2;
    }

    .max-loan-wrap {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      background: #ffffff;
      border: 2px solid #ecf0f1;
      margin-top: 8px;
    }

    .max-loan-sub {
      margin-top: 4px;
      font-size: 12px;
      color: #7f8c8d;
    }

    @media (max-width: 480px) {
      .container { padding: 20px; }
      h1 { font-size: 24px; }
    }

  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>üí∞ Calculadora principal</h1>
      <p class="subtitle">Herramienta comparativa de financieras</p>
    </header>

    <div class="form-group">
      <label for="estado">Estado</label>
      <select id="estado"
        style="width:100%;padding:12px;border:2px solid #ecf0f1;border-radius:6px;font-size:16px;">
      </select>
    </div>

    <div class="form-group">
      <label for="convenio">Convenio</label>
      <select id="convenio"
        style="width:100%;padding:12px;border:2px solid #ecf0f1;border-radius:6px;font-size:16px;">
      </select>
    </div>

    <div class="form-group">
      <label for="selFinancieras">Financiera</label>
      <select id="selFinancieras"
        style="width:100%;padding:12px;border:2px solid #ecf0f1;border-radius:6px;font-size:16px;">
      </select>
      <p class="hint">Si eliges una financiera, se mostrar√°n TODOS sus plazos disponibles.</p>
    </div>

    
    <form id="loanForm">
      <div class="form-group">
        <label for="capacity">Capacidad de pago por quincena (MXN)</label>
        <input type="number" id="capacity" placeholder="(Opcional) 1500" min="0">
      </div>

      <div class="form-group">
        <label for="amount">Monto solicitado (MXN)</label>
        <input type="number" id="amount" placeholder="(Opcional) 20000" min="0">
        <p class="hint">Si dejas el monto vac√≠o, calculo el MONTO M√ÅXIMO seg√∫n tu capacidad y plazo.</p>
      </div>

      <div class="form-group">
        <label for="term">Plazo (quincenas)</label>
        <input type="number" id="term" placeholder="24" min="1">
        <p class="hint">Tip: usa plazos que existan en tu tabulador (ej. 12, 18, 24, 30...).</p>
      </div>

      <div class="form-group">
        <label for="age">Edad del cliente</label>
        <input type="number" id="age" placeholder="(Opcional) 35" min="18" max="99">
      </div>

      <div class="form-group">
        <label for="serviceYears">A√±os de servicio / antig√ºedad laboral</label>
        <input type="number" id="serviceYears" placeholder="(Opcional) 5" min="0" step="0.5">
      </div>

  

      <button type="submit">Ver opciones</button>
      <button type="button" class="install-btn" id="installBtn">Instalar app</button>
    </form>

    <div class="results" id="results">
      <div id="options"></div>
    </div>
  </div>
  <div class="results" id="rejectedBox" style="display:none; margin-top: 12px;">
    <div id="rejected"></div>
  </div>

  <script>
  // ====== PWA (instalaci√≥n) ======
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .catch(err => console.log('SW registration failed:', err));
  }

  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').classList.add('show');
  });

  document.getElementById('installBtn').addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('installBtn').classList.remove('show');
    }
  });

  // ====== Cargar data.json ======
  let DATA = null;

function upsertFinanciera(arr, obj) {
  const i = arr.findIndex(x => x.id === obj.id);
  if (i >= 0) arr[i] = obj;     // reemplaza
  else arr.push(obj);           // inserta
}

async function cargarDatos() {
  const baseRes = await fetch('data.json', { cache: 'no-store' });
  if (!baseRes.ok) throw new Error('No se pudo cargar data.json');
  const base = await baseRes.json();

  base.financieras = Array.isArray(base.financieras) ? base.financieras : [];

  // === 1) Mezcla credifiel_snte23 (archivo individual) ===
  try {
    const credRes = await fetch('credifiel_snte23.json', { cache: 'no-store' });
    if (credRes.ok) {
      const credifielSNTE23 = await credRes.json();
      upsertFinanciera(base.financieras, credifielSNTE23);
    } else {
      console.warn('No se pudo cargar credifiel_snte23.json (status)', credRes.status);
    }
  } catch (err) {
    console.warn('Error cargando credifiel_snte23.json', err);
  }

  // === 2) Mezcla gobierno.json (pack con varias financieras) ===
  try {
    const govRes = await fetch('gobierno.json', { cache: 'no-store' });
    if (govRes.ok) {
      const govPack = await govRes.json();
      const extras = Array.isArray(govPack.financieras) ? govPack.financieras : [];

      extras.forEach(fin => upsertFinanciera(base.financieras, fin));
    } else {
      console.warn('No se pudo cargar gobierno.json (status)', govRes.status);
    }
  } catch (err) {
    console.warn('Error cargando gobierno.json', err);
  }

  DATA = base;
  window.DATA = DATA;


    // ‚úÖ Validaci√≥n (incluye convenios)
    if (!DATA?.financieras || !Array.isArray(DATA.financieras)) {
      throw new Error('data.json no tiene el formato esperado: { "financieras": [...] }');
    }
    if (!DATA?.convenios || !Array.isArray(DATA.convenios)) {
      throw new Error('data.json no tiene "convenios": [ ... ]');
    }

    // ‚úÖ AQUI estaba faltando:
    poblarConvenios();
    poblarEstados();           // o poblarConveniosPorEstado si ya la usas
    poblarSelectorFinancieras();

  }

  function money(n) {
    if (!isFinite(n)) return '-';
    return n.toLocaleString('es-MX', {
      style: 'currency',
      currency: 'MXN',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  // ====== Helper para obtener convenios de una financiera ======
  function getConvenios(fin) {
    // soporta: convenios: ["snte51"]  √≥  convenio: "snte51"  √≥  convenio: ["snte51"]
    if (Array.isArray(fin.convenios)) return fin.convenios;
    if (Array.isArray(fin.convenio)) return fin.convenio;
    if (typeof fin.convenio === "string") return [fin.convenio];
    return [];
  }

  // ====== Filtrar convenios por estado seleccionado ======
  function filtrarConveniosPorEstado(data, estadoSel) {
    const convenios = Array.isArray(data.convenios) ? data.convenios : [];
    return convenios.filter(c => c.estado === estadoSel);
  }

  // ====== Filtrar financieras por convenio seleccionado ======
  function filtrarFinancierasPorConvenio(data, convenioSel) {
    if (convenioSel === "todas") return data.financieras;
    return data.financieras.filter(f => getConvenios(f).includes(convenioSel));
  }

  function poblarSelectorFinancieras() {
    const sel = document.getElementById("selFinancieras");
    if (!sel) return;

    const convenioSel = document.getElementById("convenio").value;

    sel.innerHTML = '<option value="todas">Todas</option>';

    const disponibles = filtrarFinancierasPorConvenio(DATA, convenioSel);

    // Debug logging
    console.table(disponibles.map(f => ({
      id: f.id,
      nombre: f.nombre,
      convenios: getConvenios(f)
    })));

    disponibles.forEach(fin => {
      const opt = document.createElement("option");
      opt.value = fin.id;
      opt.textContent = fin.nombre;
      sel.appendChild(opt);
    });

    sel.value = "todas"; // por defecto: todas
  }


  // ====== Poblar convenios ======
  function poblarConvenios() {
    const sel = document.getElementById('convenio');
    sel.innerHTML = '';

    const convenios = Array.isArray(DATA.convenios) ? DATA.convenios : [];
    const def = DATA.defaultConvenio || (convenios[0]?.id ?? '');

    // Ordenar para que SNTE 23 salga primero
    convenios.sort((a, b) => (a.id === 'snte23' ? -1 : b.id === 'snte23' ? 1 : 0));

    for (const c of convenios) {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.nombre;
      sel.appendChild(opt);
    }

    sel.value = def || 'snte23' || sel.value;
  }

  // ====== Poblar estados ======
  function poblarEstados() {
    const sel = document.getElementById('estado');
    if (!sel) return;

    sel.innerHTML = '';

    const estados = Array.isArray(DATA.estados) ? DATA.estados : [];
    const def = DATA.defaultEstado || (estados[0]?.id ?? '');

    for (const e of estados) {
      const opt = document.createElement('option');
      opt.value = e.id;
      opt.textContent = e.nombre;
      sel.appendChild(opt);
    }

    sel.value = def || sel.value;
  }

  // ====== Obtener plazos permitidos desde diferentes estructuras ======
  function getPlazosPermitidos(fin) {
    // 1) expl√≠citos
    if (Array.isArray(fin.plazos_permitidos)) return fin.plazos_permitidos.map(Number);
    if (Array.isArray(fin.plazos)) return fin.plazos.map(Number);
    if (Array.isArray(fin.reglas?.plazos_quincenas)) return fin.reglas.plazos_quincenas.map(Number);

    // 2) inferidos desde tabla {monto, plazos:{...}}
    const row = (fin.tabla && fin.tabla[0]) || (fin.tabulador && fin.tabulador[0]);
    if (row?.plazos) return Object.keys(row.plazos).map(Number);

    // 3) inferidos desde tablas separadas {"36":[...], "48":[...]}
    if (fin.tablas && typeof fin.tablas === "object") return Object.keys(fin.tablas).map(Number);

    return [];
  }

  // ====== Tabulador fijo: (monto exacto + plazo exacto => pago quincenal) ======
  function buscarPago(fin, monto, plazoStr) {
    if (!fin.tabla || !Array.isArray(fin.tabla)) return null;

    const fila = fin.tabla.find(r => Number(r.monto) === Number(monto));
    if (!fila) return null;

    const pago = fila.plazos?.[plazoStr];
    if (pago == null) return null;

    return Number(pago);
  }

  // ====== Validaci√≥n de reglas (soporta edad/servicio opcionales) ======
  function cumpleReglas(fin, edad, servicio, plazoQuincenas) {
    const r = fin.reglas || {};

    // Si NO hay edad, no filtramos por edad
    if (edad != null) {
      if (r.edadMin != null && edad < r.edadMin) return false;

      if (!r.edadIncluyePlazo) {
        if (r.edadMax != null && edad > r.edadMax) return false;
      } else if (r.edadMax != null) {
        const edadAlFinal = edad + (plazoQuincenas / 24);
        if (edadAlFinal > r.edadMax) return false;
      }

      // Validaci√≥n: edad actual + duraci√≥n del cr√©dito (en a√±os) ‚â§ 67
      const edadAlFinal = edad + (plazoQuincenas / 24);
      if (edadAlFinal > 67) return false;
    }

    // Si NO hay servicio, no filtramos por servicio
    if (servicio != null) {
      if (r.servicioMin != null && servicio < r.servicioMin) return false;
      if (r.servicioMax != null && servicio > r.servicioMax) return false;

      // Riesgo jubilaci√≥n solo si hay edad y servicio
      if (edad != null && r.riesgoJubilacion?.aplica) {
        for (const lim of (r.riesgoJubilacion.limites || [])) {
          if (servicio >= lim.servicioAnios && edad >= lim.edadMin) return false;
        }
      }
    }

    return true;
  }

  // ====== Buscar monto m√°ximo por capacidad ======
  function buscarMontoMaxPorCapacidad(fin, plazoStr, capacidad) {
    if (!fin.tabla || !Array.isArray(fin.tabla)) return null;
    if (capacidad == null || !isFinite(capacidad)) return null;

    let mejor = null; // { monto, pagoQ }

    for (const fila of fin.tabla) {
      const pago = fila.plazos?.[plazoStr];
      if (pago == null) continue;

      const pagoQ = Number(pago);
      const monto = Number(fila.monto);

      if (!isFinite(pagoQ) || !isFinite(monto)) continue;

      // Si cabe en la capacidad, buscamos el monto m√°s alto
      if (pagoQ <= capacidad) {
        if (!mejor || monto > mejor.monto) {
          mejor = { monto, pagoQ };
        }
      }
    }

    return mejor; // null si nada cabe
  }

  // ====== Validaci√≥n de tabla de edad por servicio (Credifiel) ======
  function validaTablaEdadCredifiel(fin, edad, servicio) {
    if (!fin || !edad || !servicio) return null;

    // Solo aplica a Credifiel SNTE 23 y SNTE 51
    if (fin.id !== "credifiel_snte23" && fin.id !== "credifiel_snte51") return null;

    const mapa = fin.reglas?.tablaEdad?.maxEdadPorServicio || {};
    const maxDefault = Number(fin.reglas?.tablaEdad?.maxEdadDefault ?? 70);

    let maxEdad = maxDefault;

    // Regla resumida (seg√∫n la tabla)
    if (servicio >= 30) maxEdad = 65;
    else if (servicio === 29) maxEdad = 66;
    else if (servicio === 28) maxEdad = 67;
    else if (mapa[String(servicio)] != null) maxEdad = Number(mapa[String(servicio)]);

    if (edad > maxEdad) return `Excede edad m√°xima (${maxEdad}) para ${servicio} a√±os de servicio.`;
    return null;
  }

  // ====== Validaci√≥n de a√±os de servicio m√°ximo por edad (Credifiel) ======
  // ====== Helper para b√∫squeda de tramos ======
  function maxServicioPorEdadFinal_Tramos(tramos, edadFinal) {
    // prioridad:
    // 1) tramo exacto (edadFinal)
    // 2) rango por min (edadFinalMin)
    // 3) rango por max (edadFinalMax)

    // exactos primero
    for (const t of tramos) {
      if (t.edadFinal != null && Number(t.edadFinal) === edadFinal) return Number(t.maxServicio);
    }
    // luego min
    for (const t of tramos) {
      if (t.edadFinalMin != null && edadFinal >= Number(t.edadFinalMin)) return Number(t.maxServicio);
    }
    // luego max
    for (const t of tramos) {
      if (t.edadFinalMax != null && edadFinal <= Number(t.edadFinalMax)) return Number(t.maxServicio);
    }
    return null;
  }

  function validaTablaEdadServicioCredifiel(fin, edad, servicio, plazo) {
    if (edad == null || servicio == null || plazo == null) return null;

    // Solo aplica a Credifiel SNTE 23 y 51
    if (fin.id !== "credifiel_snte23" && fin.id !== "credifiel_snte51") return null;

    const cfg = fin.reglas?.tablaEdadServicio;
    if (!cfg) return null;

    // üëâ usar edad al finalizar
    const edadFinal = Math.ceil(edad + (plazo / 24));

    // TIPO 1: Tabla discreta (maxServicioPorEdad)
    if (cfg.tipo === "maxServicioPorEdad") {
      const edadKey = String(edadFinal);
      const maxMap = cfg.maxServicioPorEdad || {};
      const maxServicio = maxMap[edadKey];

      if (maxServicio == null) return null;
      if (servicio > Number(maxServicio)) return "Excede a√±os de servicio";
    }
    
    // TIPO 2: F√≥rmula diagonal (80 - edadFinal)
    else if (cfg.tipo === "diagonal_80_menos_edadFinal") {
      let maxServicio = 80 - edadFinal;
      if (maxServicio > 33) maxServicio = 33;
      if (maxServicio < 5) maxServicio = 5;

      if (servicio > maxServicio) return "Excede a√±os de servicio";
    }

    // TIPO 3: Tramos (maxServicioPorEdad_Tramos)
    else if (cfg.tipo === "tramos_max_servicio_por_edadFinal") {
      const maxServ = maxServicioPorEdadFinal_Tramos(cfg.tramos || [], edadFinal);

      if (maxServ == null) return null;
      if (servicio > maxServ) return `Excede a√±os de servicio (m√°x ${maxServ} para edad final ${edadFinal})`;
    }

    return null;
  }

  // ====== Evento principal ======
  const form = document.getElementById('loanForm');
  if (!form) {
    console.error("No existe #loanForm");
  } else {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      try {
        if (!DATA) await cargarDatos();

      const capacidadRaw = document.getElementById('capacity')?.value?.trim() ?? '';
      const montoRaw = document.getElementById('amount')?.value?.trim() ?? '';
      const edadRaw = document.getElementById('age')?.value?.trim() ?? '';
      const servicioRaw = document.getElementById('serviceYears')?.value?.trim() ?? '';
      const convenioSel = document.getElementById('convenio')?.value ?? '';

      const capacidad = capacidadRaw === '' ? null : Number(capacidadRaw);
      const monto = montoRaw === '' ? null : Number(montoRaw);
      const edad = edadRaw === '' ? null : Number(edadRaw);
      const servicio = servicioRaw === '' ? null : Number(servicioRaw);

      const plazoRaw = document.getElementById('term')?.value?.trim() ?? '';
      const plazo = plazoRaw === '' ? null : Number(plazoRaw);
      const plazoStr = plazo == null ? null : String(plazo);

      const contenedor = document.getElementById('options');
      const rechazadosCont = document.getElementById('rejected');
      const rechazadosBox = document.getElementById('rejectedBox');

      if (!contenedor || !rechazadosCont || !rechazadosBox) {
        console.error("Falta #options o #rejected o #rejectedBox");
        return;
      }

      contenedor.innerHTML = '';
      rechazadosCont.innerHTML = '';
      rechazadosBox.style.display = 'none';

      const resultados = [];
      const rechazados = [];

      // Helpers para motivos
      const addReject = (fin, motivo) => rechazados.push({ fin, motivo });

      // Validaci√≥n con motivo (devuelve string motivo o null si cumple)
      function motivoReglas(fin, edad, servicio, plazo) {
        const r = fin.reglas || {};

        // 1Ô∏è‚É£ TABLA EDAD‚ÄìSERVICIO (SOLO CREDIFIEL)
        const motTabla = validaTablaEdadCredifiel(fin, edad, servicio);
        if (motTabla) return motTabla;

        // 1Ô∏è‚É£.5Ô∏è‚É£ TABLA SERVICIO‚ÄìEDAD (SOLO CREDIFIEL)
        const motTablaServicio = validaTablaEdadServicioCredifiel(fin, edad, servicio, plazo);
        if (motTablaServicio) return motTablaServicio;

        // 2Ô∏è‚É£ EDAD M√çNIMA
        if (r.edad_min != null && edad != null && edad < r.edad_min) {
          return "Edad m√≠nima no cumple";
        }

        // 3Ô∏è‚É£ EDAD M√ÅXIMA (SOLO SI EXISTE)
        if (r.edad_max != null && edad != null && edad > r.edad_max) {
          return "Edad m√°xima excedida";
        }

        // 4Ô∏è‚É£ EDAD AL FINALIZAR
        if (r.edad_max_al_finalizar != null && edad != null && plazo != null) {
          const edadFinal = edad + (plazo / 24);
          if (edadFinal > r.edad_max_al_finalizar) {
            return "Edad al finalizar excede l√≠mite";
          }
        }

        // 5Ô∏è‚É£ ANTIG√úEDAD
        if (r.antiguedad_min_anios != null && servicio != null && servicio < r.antiguedad_min_anios) {
          return "Antig√ºedad insuficiente";
        }

        return null;
      }

      // ===============================
      // Determinar financieras a procesar
      // ===============================
      const finSel = document.getElementById("selFinancieras")?.value ?? 'todas';

      // Las disponibles por convenio
      const disponibles = filtrarFinancierasPorConvenio(DATA, convenioSel);

      // Clave: si es "todas", procesas todas; si no, solo 1
      const financierasAProcesar =
        finSel === "todas"
          ? disponibles
          : disponibles.filter(f => f.id === finSel);

      // Si no hay ninguna, muestra error claro
      if (!financierasAProcesar.length) {
        console.warn("No hay financieras para procesar", { convenioSel, finSel });
        contenedor.innerHTML = `
          <div class="result-item">
            <span class="result-label">Sin financieras</span>
            <span class="result-value">No hay financieras disponibles para el convenio seleccionado</span>
          </div>`;
        document.getElementById('results').classList.add('show');
        return;
      }

      // ===============================
      // ‚úÖ MODO A: una financiera seleccionada ‚Üí mostrar TODOS sus plazos
      // ===============================
      if (financierasAProcesar.length === 1 && finSel !== "todas") {
        const fin = financierasAProcesar[0];
        const nombreFin = fin.nombre || fin.id;

        const plazos = getPlazosPermitidos(fin);
        
        // üëá Si el usuario seleccion√≥ un plazo, solo mostramos ese
        const plazosAmostrar = (plazo != null) ? [plazo] : plazos;
        
        const plazosPermitidos = plazos.map(String);
        
        // Debug logging
        console.log("FIN:", fin.id, fin.nombre);
        console.log("plazoSel:", document.querySelector('#term').value, typeof document.querySelector('#term').value);
        console.log("plazosPermitidos:", plazos);
        
        if (plazos.length === 0) {
          contenedor.innerHTML = `
            <div class="result-item">
              <span class="result-label">${fin.nombre}</span>
              <span class="result-value">Sin plazosPermitidos</span>
            </div>`;
          document.getElementById('results').classList.add('show');
          return;
        }

        // Validar plazo seleccionado
        if (plazo != null && !plazos.includes(plazo)) {
          contenedor.innerHTML = `
            <div class="result-item">
              <span class="result-label">${fin.nombre}</span>
              <span class="result-value">Plazo ${plazo}Q no disponible. Plazos: ${plazos.join(", ")}Q</span>
            </div>`;
          document.getElementById('results').classList.add('show');
          return;
        }

        // Si monto vac√≠o -> requiere capacidad
        if (monto == null && capacidad == null) {
          contenedor.innerHTML = `
            <div class="result-item">
              <span class="result-label">${fin.nombre}</span>
              <span class="result-value">Captura Monto o Capacidad</span>
            </div>`;
          document.getElementById('results').classList.add('show');
          return;
        }

        // ‚úÖ Validar tablas de edad/servicio ANTES de procesar plazos
        const motTabla = validaTablaEdadServicioCredifiel(fin, edad, servicio, plazo);
        if (motTabla) {
          contenedor.innerHTML = `
            <div class="result-item">
              <span class="result-label">${fin.nombre}</span>
              <span class="result-value">${motTabla}</span>
            </div>`;
          document.getElementById('results').classList.add('show');
          return;
        }

        // Render base (mismo estilo)
        let html = `
          <div class="result-item" style="flex-direction:column; align-items:flex-start;">
            <div style="width:100%; display:flex; justify-content:space-between; gap:14px; align-items:center;">
              <span class="result-label">${fin.nombre}</span>
              <span class="result-value">Plazos disponibles: ${plazos.join(", ")}Q</span>
            </div>
          </div>
        `;

        // Por cada plazo, calcula
        for (const p of plazosAmostrar) {
          const motTabla = validaTablaEdadServicioCredifiel(fin, edad, servicio, p);
          if (motTabla) {
            html += `
              <div class="result-item">
                <span class="result-label">${p}Q</span>
                <span class="result-value" style="color:#7f8c8d;font-weight:600;">${motTabla}</span>
              </div>`;
            continue;
          }  
          const mot = motivoReglas(fin, edad, servicio, p);
          if (mot) {
            html += `
              <div class="result-item">
                <span class="result-label">${p}Q</span>
                <span class="result-value" style="color:#7f8c8d;font-weight:600;">${mot}</span>
              </div>`;
            continue;
          }

          if (monto != null) {
            // pago por monto exacto
            const pagoQ = buscarPago(fin, monto, String(p));
            if (pagoQ == null) {
              html += `
                <div class="result-item" style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
                  <span class="result-label" style="width:70px;">${p}Q</span>
                  <span style="flex:1; text-align:center; font-weight:700; opacity:.85;">${fin.nombre}</span>
                  <span class="result-value" style="color:#7f8c8d;font-weight:600; text-align:right;">No existe en tabla</span>
                </div>`;
              continue;
            }
            html += `
              <div class="result-item" style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
                <span class="result-label" style="width:70px;">${p}Q</span>
                <span style="flex:1; text-align:center; font-weight:700; opacity:.85;">${fin.nombre}</span>
                <span class="result-value" style="text-align:right;">${money(pagoQ)} / quincena</span>
              </div>`;
          } else {
            // monto m√°ximo por capacidad
            const best = buscarMontoMaxPorCapacidad(fin, String(p), capacidad);
            if (!best) {
              html += `
                <div class="result-item">
                  <span class="result-label">${p}Q</span>
                  <span class="result-value" style="color:#7f8c8d;font-weight:600;">No alcanza monto m√≠nimo</span>
                </div>`;
              continue;
            }
            html += `
              <div class="result-item" style="flex-direction:column; align-items:flex-start;">
                <div style="width:100%; display:flex; justify-content:space-between; gap:14px; align-items:center;">
                  <span class="result-label" style="width:70px;">${p}Q</span>
                  <span style="flex:1; text-align:center; font-weight:700; opacity:.85;">${fin.nombre}</span>
                  <span class="result-value" style="text-align:right;">${money(best.pagoQ)} / quincena</span>
                </div>
                <div class="max-loan-wrap">
                  <div class="max-loan">Monto m√°ximo: ${money(best.monto)}</div>
                  <div class="max-loan-sub">Con capacidad: ${money(capacidad)}</div>
                </div>
              </div>`;
          }
        }

        contenedor.innerHTML = html;
        document.getElementById('results').classList.add('show');
        return; // ‚úÖ important√≠simo: evita que siga al modo "todas"
      }

      // ===============================
      // ‚úÖ MODO B: comparar todas las financieras del convenio
      // ===============================
      for (const fin of financierasAProcesar) {

        const reglasBase = fin.reglas || {};
        const reglasC = fin.reglasPorConvenio?.[convenioSel] || {};
        const reglasFinal = { ...reglasBase, ...reglasC };

        // 1) Reglas edad/servicio (si est√°n vac√≠as no filtran)
        const mot = motivoReglas(fin, edad, servicio, plazo);
        if (mot) { addReject(fin, mot); continue; }

        // 2) Plazos permitidos
        const plazosPermitidos = getPlazosPermitidos(fin).map(String);
        if (plazosPermitidos.length > 0 && !plazosPermitidos.includes(String(plazo))) continue;

        let pagoQ = null;
        let montoUsado = monto;

        // ===== MODO B: monto vac√≠o -> calcular monto m√°ximo con capacidad =====
        if (monto == null) {
          if (capacidad == null) continue; // sin capacidad no se puede calcular monto m√°ximo
          const best = buscarMontoMaxPorCapacidad(fin, plazoStr, capacidad);
          if (!best) continue;

          montoUsado = best.monto;
          pagoQ = best.pagoQ;
        } 
        // ===== MODO A: monto definido -> buscar pago por tabulador =====
        else {
          // Montos min/max
          if (fin.montoMin != null && monto < Number(fin.montoMin)) continue;
          if (fin.montoMax != null && monto > Number(fin.montoMax)) continue;

          pagoQ = buscarPago(fin, monto, plazoStr);
          if (pagoQ == null) continue;
        }

        // 3) Capacidad (opcional):
        const pasa = (capacidad == null) ? null : (pagoQ <= capacidad);

        resultados.push({ fin, pagoQ, pasa, montoUsado });
      }

      // Ordena: primero las que s√≠ pasan capacidad, luego por menor pago
      resultados.sort((a, b) => {
        // Si no hay capacidad, solo ordena por pago
        if (capacidad == null) return a.pagoQ - b.pagoQ;        
        // Si hay capacidad, primero los que pasan (pasa=true), luego por pago
        const aRank = a.pasa ? 0 : 1;
        const bRank = b.pasa ? 0 : 1;
        if (aRank !== bRank) return aRank - bRank;
        return a.pagoQ - b.pagoQ;
      });

      // Render opciones
      if (resultados.length === 0) {
        contenedor.innerHTML = `
          <div class="result-item">
            <span class="result-label">Sin opciones disponibles</span>
            <span class="result-value">Revisa reglas / monto / plazo</span>
          </div>
        `;
      } else {
        for (const r of resultados) {
          const badge = (r.pasa === null) ? '' : (r.pasa ? '‚úÖ' : '‚ùå');
          const esModoMontoMax = (monto == null); // monto vac√≠o => modo monto m√°ximo

          contenedor.innerHTML += `
            <div class="result-item" style="flex-direction:column; align-items:flex-start;">
              <div style="width:100%; display:flex; justify-content:space-between; gap:14px; align-items:center;">
                <span class="result-label">${r.fin.nombre ?? 'Financiera'}</span>
                <span class="result-value">${money(r.pagoQ)} / quincena ${badge}</span>
              </div>

              ${
                esModoMontoMax
                  ? `
                    <div class="max-loan-wrap">
                      <div class="max-loan">Monto m√°ximo: ${money(r.montoUsado)}</div>
                      <div class="max-loan-sub">Plazo: ${plazo}Q ¬∑ Con capacidad: ${capacidad == null ? '-' : money(capacidad)}</div>
                    </div>
                  `
                  : `
                    <div class="hint" style="margin-top:6px;">
                      Monto evaluado: <b>${money(r.montoUsado)}</b> ‚Äî Plazo: <b>${plazo}Q</b>
                    </div>
                  `
              }
              ${r.fin.notas ? `<div class="hint" style="margin-top:6px;">${r.fin.notas}</div>` : ''}
            </div>
          `;
        }
      }

      // Render rechazadas (motivos)
      if (rechazados.length > 0) {
        rechazadosBox.style.display = 'block';
        rechazadosCont.innerHTML = `
          <div class="result-item" style="border-bottom: none; padding-bottom: 6px;">
            <span class="result-label">Financieras descartadas</span>
            <span class="result-value">${rechazados.length}</span>
          </div>
        `;

        for (const r of rechazados) {
          rechazadosCont.innerHTML += `
            <div class="result-item" style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
              <span class="result-label" style="width:100px;">${r.fin.nombre ?? 'Financiera'}</span>
              <span class="result-value" style="color:#7f8c8d;font-weight:600; text-align:right; flex:1;">
                ${r.motivo}
              </span>
            </div>
          `;
        }
      }

      document.getElementById('results').classList.add('show');

    } catch (err) {
      console.error(err);
      alert('Error: ' + err.message);
    }
    });
  }

  // ‚úÖ Cargar data.json y mostrar convenios al abrir la app
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      await cargarDatos(); // aqu√≠ se llena el select de convenios
      
      // ‚úÖ Actualizar financieras cuando cambia el convenio
      document.getElementById("convenio").addEventListener("change", () => {
        poblarSelectorFinancieras();
      });
    } catch (err) {
      console.error(err);
      alert('Error cargando data.json');
    }
  });
  </script>
</body>
</html>